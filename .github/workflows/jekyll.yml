name: Jekyll
on:
  push:
    branches:
      - master
jobs:
  jekyll:
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt-get purge graphicsmagick graphicsmagick-dbg imagemagick-common imagemagick imagemagick-6.q16 libmagickcore-6-headers libmagickwand-dev graphicsmagick-libmagick-dev-compat; sudo apt-get autoremove; sudo apt-get install imagemagick libmagickwand-dev libpq-dev; sudo ln -s /usr/lib/x86_64-linux-gnu/ImageMagick-6.8.9/bin-Q16/Magick-config /usr/bin/Magick-config; export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig

      - uses: actions/checkout@v2

      - uses: actions/cache@v2
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7

      - run: gem install bundler

      - run: bundle install

      - run: ruby generate.rb

      - run: for i in {1..10}; do find . -type f -name "*.png" -exec pngquant --force --skip-if-larger --output {} --speed 1 {} \;; done

      - uses: helaili/jekyll-action@v2
        with:
          token: ${{ secrets.TOKEN }}
